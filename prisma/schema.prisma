generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  accounts      Account[]
  sessions      Session[]
  projects      Project[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Account {
  id                    String   @id @default(cuid())
  userId                String
  providerId            String
  accountId             String
  accessToken           String?  @db.Text
  refreshToken          String?  @db.Text
  idToken               String?  @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification_tokens")
}

model Project {
  id              String     @id @default(cuid())
  name            String
  description     String?
  repoUrl         String?
  githubRepo      String?    @map("github_repo")
  sentryOrg       String?    @map("sentry_org")
  sentryProject   String?    @map("sentry_project")
  sentryToken     String?    @map("sentry_token")
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedback        Feedback[]
  themes          Theme[]
  analyses        Analysis[]
  feedbackJobs    FeedbackJob[]
  decisions       Decision[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@map("projects")
}

model Feedback {
  id              String                       @id @default(cuid())
  text            String                       @db.Text
  source          String?
  type            String?                      // bug, feature
  customerTier    String?
  revenue         Float?
  status          String                       @default("pending_analysis") // pending_analysis, analyzed, ready_for_implementation, shipped
  analysisModel   String?                      @map("analysis_model")
  githubPrUrl     String?                      @map("github_pr_url")
  githubIssueUrl  String?                      @map("github_issue_url")
  sentryIssueId   String?                      @map("sentry_issue_id")
  sentryIssueUrl  String?                      @map("sentry_issue_url")
  errorFrequency  Int?                         @map("error_frequency")
  spec            Json?
  pageUrl         String?                      @map("page_url")
  browserInfo     String?                      @map("browser_info")
  shippedAt       DateTime?                    @map("shipped_at")
  embedding       Unsupported("vector(1536)")?
  projectId       String
  project         Project                      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt @default(now())

  @@map("feedback")
}

model Theme {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@map("themes")
}

model Analysis {
  id        String   @id @default(cuid())
  content   Json
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("analyses")
}

model FeedbackJob {
  id            String   @id @default(cuid())
  projectId     String
  status        String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  filename      String?
  fileType      String?
  totalItems    Int      @default(0)
  processedItems Int     @default(0)
  failedItems   Int      @default(0)
  errors        Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("feedback_jobs")
}

model Decision {
  id              String   @id @default(cuid())
  projectId       String
  title           String
  summary         String   @db.Text
  scope           String   @db.Text
  nonGoals        String   @db.Text @map("non_goals")
  acceptanceCriteria String @db.Text @map("acceptance_criteria")
  risks           String   @db.Text
  confidenceScore Float    @default(0) @map("confidence_score")
  status          String   @default("draft") // draft, reviewed, sent
  linkedFeedbackIds String[] @map("linked_feedback_ids")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("decisions")
}

// ============================================
// AGENT MODELS - Product Builder Agents
// ============================================

model AgentTask {
  id            String   @id @default(cuid())
  agent         String   // research, spec, build, marketing, feedback, iterate
  status        String   @default("pending") // pending, running, waiting, completed, failed
  input         Json
  output        Json?
  checkpoint    String?  // checkpoint identifier
  humanApproved Boolean  @default(false)
  humanFeedback String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([agent, status])
  @@index([status])
  @@map("agent_tasks")
}

model AgentMessage {
  id              String   @id @default(cuid())
  taskId          String
  task            AgentTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  from            String   // agent type
  to              String   // agent type
  action          String   // task_request, task_complete, etc.
  payload         Json
  requiresApproval Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([taskId])
  @@map("agent_messages")
}

model Checkpoint {
  id          String   @id @default(cuid())
  taskId      String
  task        AgentTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  checkpointId String   @unique
  question    String   @db.Text
  approved    Boolean?
  feedback    String?
  createdAt   DateTime @default(now())

  @@index([taskId])
  @@map("checkpoints")
}

model ResearchResult {
  id          String   @id @default(cuid())
  projectId   String
  summary     String   @db.Text
  details     Json
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@map("research_results")
}

model ProductSpec {
  id          String   @id @default(cuid())
  projectId   String
  content     Json
  version     Int      @default(1)
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@map("product_specs")
}

model Build {
  id            String   @id @default(cuid())
  projectId     String
  githubUrl     String?
  deployedUrl    String?
  filesCreated   Int      @default(0)
  technologies   String[]
  status        String   @default("pending") // pending, building, deployed, failed
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@map("builds")
}

model Campaign {
  id            String   @id @default(cuid())
  projectId     String
  productUrl    String?
  landingPage   String?
  launchCopy     Json?
  postedChannels String[]
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@map("campaigns")
}

// A2A Workflow tracking
model AgentWorkflow {
  id            String   @id @default(cuid())
  projectId     String
  workflowType   String   // create_landing_page, full_product_launch
  status        String   @default("running") // running, completed, failed
  steps         String[]  // JSON serialized workflow steps
  context       Json?     // Original request context
  output        Json?     // Final output
  error         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@map("agent_workflows")
}

// Feedback Analysis
model FeedbackAnalysis {
  id          String   @id @default(cuid())
  projectId   String
  sentiment   String   // positive, neutral, negative
  score      Float    // 1-10
  highlights  String[]
  concerns    String[]
  suggestions Json?
  themes     Json?
  rawFeedback Json?
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@map("feedback_analyses")
}
